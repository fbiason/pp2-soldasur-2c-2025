<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEISA - SOLDASUR S.A - Sistema Unificado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos base */
        .chat-message { max-width: 80%; word-wrap: break-word; }
        .user-message { margin-left: auto; background-color: #05684f; color: white; }
        .system-message { background-color: #02287a; color: white; }
        .option-btn { transition: all 0.2s; }
        .option-btn:hover { transform: translateY(-2px); }
        .loading-spinner { 
            display: inline-block; width: 1rem; height: 1rem; 
            border: 2px solid rgba(255,255,255,.3); border-radius: 50%; 
            border-top-color: #fff; animation: spin 1s ease-in-out infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Indicadores de modo */
        .mode-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .mode-expert {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .mode-rag {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        
        .mode-hybrid {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        /* Panel de contexto */
        .context-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .context-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        
        /* Sugerencias */
        .suggestion-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        
        /* Productos */
        .product-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin: 0.5rem 0;
            transition: all 0.2s;
        }
        
        .product-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        /* Transiciones suaves */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Overlay de Login (OCULTO TEMPORALMENTE) -->
    <div id="login-overlay" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 z-50 hidden">
        <div class="bg-white w-full max-w-sm rounded-lg shadow-lg p-8 space-y-6">
            <h2 class="text-2xl font-bold text-center text-gray-800">Iniciar Sesi√≥n</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                    <input id="login-username" type="text" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="admin">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                    <input id="login-password" type="password" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="admin">
                </div>
                <p id="login-error" class="text-red-600 text-sm"></p>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Acceder</button>
            </form>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="container mx-auto p-4 h-screen flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col w-full max-w-2xl h-5/6">
            <!-- Header con indicador de modo -->
            <div class="bg-blue-800 text-white p-4">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <h1 class="text-xl font-bold">PEISA - SOLDASUR S.A</h1>
                        <p class="text-sm opacity-80">Asistente Inteligente Unificado</p>
                    </div>
                    <div id="mode-indicator" class="mode-indicator mode-hybrid">
                        ‚ö° Modo H√≠brido
                    </div>
                </div>
                <!-- Selector de modo -->
                <div class="flex gap-2 mt-3">
                    <button onclick="switchMode('expert')" class="text-xs px-3 py-1 bg-blue-700 hover:bg-blue-600 rounded transition">
                        ü§ñ Experto
                    </button>
                    <button onclick="switchMode('rag')" class="text-xs px-3 py-1 bg-blue-700 hover:bg-blue-600 rounded transition">
                        üí¨ Chat Libre
                    </button>
                    <button onclick="switchMode('hybrid')" class="text-xs px-3 py-1 bg-blue-700 hover:bg-blue-600 rounded transition">
                        ‚ö° H√≠brido
                    </button>
                </div>
            </div>
            
            <!-- Panel de contexto (opcional) -->
            <div id="context-panel" class="context-panel hidden">
                <div class="font-semibold mb-2">üìä Contexto actual:</div>
                <div id="context-items"></div>
            </div>
            
            <!-- Chat container -->
            <div id="chat-container" class="flex-1 p-4 pb-6 overflow-y-auto space-y-3"></div>
            
            <!-- Input area -->
            <div id="input-area" class="p-4 border-t border-gray-200 bg-gray-50 mt-auto"></div>
        </div>
    </div>

    <script>
        /* Estado Global */
        let conversationId = 'user_' + Math.random().toString(36).substr(2, 9);
        let lastUserResponse = null;
        let isLoading = false;
        let currentMode = 'hybrid';
        let contextData = {};

        /* Login */
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-iniciar sin login (para debugging)
            startConversation();
            
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('login-username').value.trim();
                const password = document.getElementById('login-password').value.trim();
                const errorLabel = document.getElementById('login-error');

                if (username === 'admin' && password === 'admin') {
                    document.getElementById('login-overlay').classList.add('hidden');
                    startConversation();
                } else {
                    errorLabel.textContent = 'Usuario o contrase√±a incorrectos';
                }
            });
        });

        /* Cambio de modo */
        function switchMode(mode) {
            currentMode = mode;
            conversationId = 'user_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('chat-container').innerHTML = '';
            lastUserResponse = null;
            contextData = {};
            updateContextPanel();
            startConversation();
        }

        /* Iniciar conversaci√≥n */
        function startConversation() {
            if (isLoading) return;
            isLoading = true;
            showLoadingIndicator();

            fetch('/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    conversation_id: conversationId,
                    mode: currentMode 
                })
            })
            .then(res => {
                if (!res.ok) throw new Error('Error en la respuesta del servidor');
                return res.json();
            })
            .then(data => {
                isLoading = false;
                hideLoadingIndicator();
                handleServerResponse(data);
            })
            .catch(err => {
                isLoading = false;
                hideLoadingIndicator();
                appendMessage('system', '<span class="text-red-600">Error al conectar con el servidor.</span>');
                console.error('Error:', err);
            });
        }

        /* Manejar respuesta del servidor */
        function handleServerResponse(response) {
            // Actualizar indicador de modo
            if (response.mode && response.mode_label) {
                updateModeIndicator(response.mode, response.mode_label);
            }

            // Actualizar contexto
            if (response.variables) {
                contextData = {...contextData, ...response.variables};
                updateContextPanel();
            }

            // Manejar errores
            if (response.error) {
                appendMessage('system', `<span class="text-red-600">Error: ${response.error}</span>`);
                return;
            }

            const inputArea = document.getElementById('input-area');
            inputArea.innerHTML = '';

            // Mostrar respuesta del usuario
            if (lastUserResponse) {
                appendMessage('user', lastUserResponse);
                lastUserResponse = null;
            }

            // Mostrar texto de respuesta
            if (response.text || response.answer) {
                const text = response.text || response.answer;
                appendMessage('system', formatResponseText(text));
            }

            // Mostrar informaci√≥n adicional (enriquecimiento RAG)
            if (response.additional_info) {
                appendMessage('system', `<div class="suggestion-box">üí° ${response.additional_info}</div>`);
            }

            // Mostrar productos (solo si hay)
            if (response.products && response.products.length > 0) {
                renderProducts(response.products);
            }

            // Mostrar sugerencia (solo si hay y no es modo RAG)
            if (response.suggestion && response.mode !== 'rag') {
                renderSuggestion(response.suggestion);
            }

            // Renderizar opciones o inputs SOLO si NO es modo RAG
            if (response.mode !== 'rag' && (response.type === 'question' || response.type === 'response')) {
                if (response.options) {
                    renderOptions(response.options, response.type === 'response');
                } else if (response.input_type === 'number') {
                    createNumberInput(response);
                } else if (response.input_type === 'multiple') {
                    createMultipleInputs(response.inputs);
                }
            }
            
            // Si es modo RAG, SIEMPRE mantener input de chat activo
            if (response.mode === 'rag') {
                createChatInput();
            }

            // Bot√≥n de reinicio si es final
            if (response.is_final) {
                createRestartButton();
            }

            scrollToBottom();
        }

        /* Actualizar indicador de modo */
        function updateModeIndicator(mode, label) {
            const indicator = document.getElementById('mode-indicator');
            indicator.textContent = label;
            indicator.className = 'mode-indicator';
            
            if (mode === 'expert') {
                indicator.classList.add('mode-expert');
            } else if (mode === 'rag') {
                indicator.classList.add('mode-rag');
            } else {
                indicator.classList.add('mode-hybrid');
            }
        }

        /* Actualizar panel de contexto */
        function updateContextPanel() {
            const panel = document.getElementById('context-panel');
            const itemsContainer = document.getElementById('context-items');
            
            if (Object.keys(contextData).length === 0) {
                panel.classList.add('hidden');
                return;
            }

            panel.classList.remove('hidden');
            itemsContainer.innerHTML = '';

            for (const [key, value] of Object.entries(contextData)) {
                if (!key.includes('_texto') && typeof value !== 'object') {
                    const item = document.createElement('div');
                    item.className = 'context-item';
                    item.innerHTML = `<span class="font-medium">${key}:</span><span>${value}</span>`;
                    itemsContainer.appendChild(item);
                }
            }
        }

        /* Renderizar productos */
        function renderProducts(products) {
            const container = document.createElement('div');
            container.className = 'mt-3';
            
            products.slice(0, 3).forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card fade-in';
                card.innerHTML = `
                    <div class="font-semibold text-blue-800">${product.model || 'N/A'}</div>
                    <div class="text-sm text-gray-600">${product.family || ''}</div>
                    ${product.power_w ? `<div class="text-sm mt-1">Potencia: ${product.power_w} W</div>` : ''}
                    ${product.description ? `<div class="text-xs text-gray-500 mt-1">${product.description.substring(0, 100)}...</div>` : ''}
                `;
                container.appendChild(card);
            });
            
            document.getElementById('chat-container').appendChild(container);
        }

        /* Renderizar sugerencia */
        function renderSuggestion(suggestion) {
            const box = document.createElement('div');
            box.className = 'suggestion-box fade-in';
            box.innerHTML = `
                <div class="font-medium mb-2">${suggestion.message || suggestion}</div>
                ${suggestion.options ? `
                    <div class="flex gap-2 mt-2">
                        ${suggestion.options.map((opt, idx) => `
                            <button onclick="handleSuggestionOption(${idx})" 
                                class="text-xs px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded transition">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                ` : ''}
            `;
            document.getElementById('chat-container').appendChild(box);
        }

        /* Renderizar opciones */
        function renderOptions(options, isResponse = false) {
            const inputArea = document.getElementById('input-area');
            const container = document.createElement('div');
            container.className = 'space-y-2';
            
            options.forEach((option, idx) => {
                const btn = document.createElement('button');
                btn.className = `option-btn w-full ${isResponse ? 'bg-green-100 hover:bg-green-200 text-green-800' : 'bg-blue-100 hover:bg-blue-200 text-blue-800'} py-2 px-4 rounded`;
                btn.textContent = option;
                btn.onclick = () => {
                    if (isLoading) return;
                    lastUserResponse = option;
                    selectOption(idx);
                };
                container.appendChild(btn);
            });
            
            inputArea.appendChild(container);
        }

        /* Crear input num√©rico */
        function createNumberInput(response) {
            const inputArea = document.getElementById('input-area');
            const form = document.createElement('form');
            form.onsubmit = (e) => {
                e.preventDefault();
                if (isLoading) return;
                const value = document.getElementById('input-value').value;
                lastUserResponse = value;
                sendReply({ input_values: { value } });
            };
            form.innerHTML = `
                <div class="flex flex-col space-y-2">
                    <input type="text" inputmode="decimal" id="input-value" required 
                        class="border border-gray-300 rounded px-3 py-2" 
                        placeholder="${response.input_label || 'Ej: 12.5'}">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        Enviar
                    </button>
                </div>
            `;
            inputArea.appendChild(form);
            document.getElementById('input-value').focus();
        }

        /* Crear m√∫ltiples inputs */
        function createMultipleInputs(inputs) {
            const inputArea = document.getElementById('input-area');
            const form = document.createElement('form');
            form.onsubmit = (e) => {
                e.preventDefault();
                if (isLoading) return;
                const values = {};
                inputs.forEach(inp => {
                    values[inp.name] = document.getElementById(`input-${inp.name}`).value;
                });
                lastUserResponse = `Valores ingresados: ${Object.entries(values).map(([k,v]) => `${k}=${v}`).join(', ')}`;
                sendReply({ input_values: values });
            };
            
            const fieldsHTML = inputs.map(inp => `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${inp.label}</label>
                    <input type="${inp.type || 'text'}" inputmode="decimal" id="input-${inp.name}" required 
                        class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Ej: 4.5">
                </div>
            `).join('');
            
            form.innerHTML = `
                <div class="space-y-4">
                    ${fieldsHTML}
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition">
                        Calcular
                    </button>
                </div>
            `;
            inputArea.appendChild(form);
        }

        /* Crear bot√≥n de reinicio */
        function createRestartButton() {
            const inputArea = document.getElementById('input-area');
            const btn = document.createElement('button');
            btn.className = 'w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition';
            btn.textContent = 'Iniciar nuevo c√°lculo';
            btn.onclick = () => {
                if (isLoading) return;
                switchMode(currentMode);
            };
            inputArea.appendChild(btn);
        }

        /* Crear input de chat libre para modo RAG */
        function createChatInput() {
            const inputArea = document.getElementById('input-area');
            inputArea.innerHTML = '';
            
            const form = document.createElement('form');
            form.className = 'flex gap-2';
            form.onsubmit = (e) => {
                e.preventDefault();
                if (isLoading) return;
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                if (message) {
                    lastUserResponse = message;
                    input.value = '';
                    sendReply({ message: message });
                }
            };
            
            form.innerHTML = `
                <input type="text" id="chat-input" 
                    class="flex-1 border border-gray-300 rounded px-3 py-2" 
                    placeholder="Escribe tu pregunta sobre calefacci√≥n..."
                    autocomplete="off">
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                    Enviar
                </button>
            `;
            
            inputArea.appendChild(form);
            document.getElementById('chat-input').focus();
        }

        /* Helpers */
        function showLoadingIndicator() {
            document.getElementById('input-area').innerHTML = 
                '<div class="text-center py-2"><div class="loading-spinner inline-block"></div></div>';
        }

        function hideLoadingIndicator() {}

        function appendMessage(sender, text) {
            const chatContainer = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `chat-message rounded-lg p-3 ${sender === 'system' ? 'system-message' : 'user-message'} fade-in`;
            div.innerHTML = text;
            chatContainer.appendChild(div);
        }

        function formatResponseText(text) {
            return text ? text.replace(/\n/g, '<br>').replace(/<br>- /g, '<br>‚Ä¢ ') : '';
        }

        function selectOption(optionIndex) {
            sendReply({ option_index: optionIndex });
        }

        function sendReply(data) {
            if (isLoading) return;
            isLoading = true;
            showLoadingIndicator();
            data.conversation_id = conversationId;
            data.message = data.message || '';

            console.log('üì§ Enviando al servidor:', data);

            fetch('/reply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => {
                console.log('üì• Respuesta del servidor:', res.status);
                if (!res.ok) throw new Error('Error en la respuesta del servidor');
                return res.json();
            })
            .then(data => {
                console.log('üì¶ Datos recibidos:', data);
                isLoading = false;
                hideLoadingIndicator();
                handleServerResponse(data);
            })
            .catch(err => {
                console.error('‚ùå Error completo:', err);
                isLoading = false;
                hideLoadingIndicator();
                appendMessage('system', '<span class="text-red-600">Error al enviar la respuesta: ' + err.message + '</span>');
            });
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function handleSuggestionOption(index) {
            // Implementar l√≥gica para manejar opciones de sugerencias
            console.log('Suggestion option selected:', index);
        }
    </script>
</body>
</html>
